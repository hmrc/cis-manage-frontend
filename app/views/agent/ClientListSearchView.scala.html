@*
 * Copyright 2025 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import views.html.helper.CSPNonce
@import viewmodels.InputWidth._
@import views.html.components._
@import viewmodels.agent.{ClientListViewModel, SearchByList}
@import viewmodels.govuk.PaginationFluency._
@import uk.gov.hmrc.govukfrontend.views.Implicits.RichSelect
@import uk.gov.hmrc.hmrcfrontend.views.viewmodels.accessibleautocomplete.AccessibleAutocomplete
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import uk.gov.hmrc.govukfrontend.views.viewmodels.table._
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content._
@import config.FrontendAppConfig
@import forms.mappings.Constants

@this(
    layout: templates.Layout,
    formHelper: FormWithCSRF,
    govukErrorSummary: GovukErrorSummary,
    govukInput: GovukInput,
    govukButton: GovukButton,
    govukSelect: GovukSelect,
    govukDetails: GovukDetails,
    paragraph: Paragraph,
    sectionBreak: SectionBreak,
    link: Link,
    h1: H1,
    h2: H2,
    govukTable: GovukTable,
    pageNavigator: PageNavigator,
    appConfig: FrontendAppConfig
)

@(form: Form[_], searchByOptions: Seq[SearchByList], clientList: Seq[ClientListViewModel], paginationViewModel: PaginationViewModel = PaginationViewModel(), sortBy: Option[String] = None, sortOrder: Option[String] = None)(implicit request: Request[_], messages: Messages)

@scripts = {
    <script src='@controllers.routes.Assets.versioned("javascripts/jquery-3.6.3.min.js")' @{CSPNonce.attr}></script>
    <script src='@controllers.routes.Assets.versioned("javascripts/moj-frontend.min.js")' @{CSPNonce.attr}></script>
    <script @{CSPNonce.attr}>
        const element = document.querySelector("#@Constants.SearchBy");
        element.setAttribute("placeholder", "@messages("agent.clientListSearch.searchBy.placeholder")");
    </script>
}

@css = {
    <link href='@controllers.routes.Assets.versioned("stylesheets/moj-frontend.min.css")' media="all" rel="stylesheet" type="text/css" />
}

@downloadYourClientList = {
    @paragraph("agent.clientListSearch.details.1.p1")
    @link("agent.clientListSearch.details.1.link", controllers.agent.routes.ClientListSearchController.downloadClientList().url)
}

@filingOnlyService = {
    @paragraph("agent.clientListSearch.details.2.p1")
    @paragraph("agent.clientListSearch.details.2.p2")
    @link("agent.clientListSearch.details.2.link", appConfig.commercialSoftwareSuppliersUrl, isNewTab = true)
}

@clientNameCell(agentClient: ClientListViewModel) = {
    @agentClient.clientLink.map { link =>
        <a href="@link.href" class="govuk-link">@link.text</a>
    }
}

@removeLinkCell(agentClient: ClientListViewModel) = {
    @agentClient.removeLink.map { link =>
        <a href="@link.href" class="govuk-link">@link.text</a>
    }
}

@getSortState(column: String) = @{
    if (sortBy.contains(column)) {
        sortOrder.getOrElse("ascending")
    } else {
        "none"
    }
}

@layout(pageTitle = title(form, messages("agent.clientListSearch.title")),
additionalScripts = Some(scripts),
additionalCss = Some(css)) {

    @formHelper(action = controllers.agent.routes.ClientListSearchController.onSubmit()) {

        @if(form.errors.nonEmpty) {
            @govukErrorSummary(ErrorSummaryViewModel(form))
        }

        @h1(messages("agent.clientListSearch.heading"))

        @paragraph(messages("agent.clientListSearch.p1"))

        @govukSelect(
            SelectViewModel(
                field = form(Constants.SearchBy),
                items = Seq(SelectItem(value = Some(""), text = messages("agent.clientListSearch.searchBy.placeholder"))) ++
                    searchByOptions.map(searchOption =>
                        SelectItem(
                            value = Some(searchOption.value),
                            text = searchOption.label
                        )
                    ),
                label = LabelViewModel(messages("agent.clientListSearch.searchBy.label")).withCssClass("govuk-label--m")
            )
            .withCssClass("govuk-input")
            .withFormGroupClasses("govuk-!-width-two-thirds")
            .withAttribute("aria-label" -> Constants.SearchBy)
            .asAccessibleAutocomplete(Some(AccessibleAutocomplete(defaultValue = Some(""), showAllValues = true)))
        )

        @govukInput(
            InputViewModel(
                field = form(Constants.SearchFilter),
                label = LabelViewModel(messages("agent.clientListSearch.searchFilter.label"))
            )
            .withHint(Hint(content = messages("agent.clientListSearch.searchFilter.label.hint")))
            .withWidth(TwoThirds)
        )

        <div class="govuk-button-group">
            @govukButton(
                ButtonViewModel(messages("site.search"))
            )
            @link(
                "agent.clientListSearch.clearSearch",
                controllers.agent.routes.ClientListSearchController.clearFilter().url,
                extraClasses = "govuk-radios--inline"
            )
        </div>

    }

    @sectionBreak()

    @h2(messages("agent.clientListSearch.table.caption"), id = Some("table-heading"))

    @if(clientList.isEmpty) {
        @govukTable(
            Table(
                caption = Some(messages("agent.clientListSearch.table.caption")),
                captionClasses = "govuk-table__caption govuk-table__caption--m govuk-visually-hidden",
                rows = Seq(
                    Seq(
                        TableRow(
                            content = Text(messages("agent.clientListSearch.noResults"))
                        )
                    )
                ),
                attributes = Map(
                    "id" -> "agent-client-no-list"
                )
            )
        )
    } else {
        @govukTable(
            Table(
                caption = Some(messages("agent.clientListSearch.table.caption")),
                captionClasses = "govuk-table__caption govuk-table__caption--m govuk-visually-hidden",
                head = Some(
                    Seq(
                        HeadCell(
                            content = Text(messages("agent.clientListSearch.th.clientName")),
                            attributes = Map("aria-sort" -> getSortState("clientName"), "data-sort-column" -> "clientName")
                        ),
                        HeadCell(
                            content = Text(messages("agent.clientListSearch.th.employersReference")),
                            attributes = Map("aria-sort" -> getSortState("employerReference"), "data-sort-column" -> "employerReference")
                        ),
                        HeadCell(
                            content = Text(messages("agent.clientListSearch.th.clientReference")),
                            attributes = Map("aria-sort" -> getSortState("clientReference"), "data-sort-column" -> "clientReference")
                        ),
                        HeadCell(
                            content = Text(messages("agent.clientListSearch.th.actions"))
                        )
                    )
                ),
                rows = clientList.map { agentClient =>
                    Seq(
                        TableRow(
                            content = HtmlContent(clientNameCell(agentClient)),
                            attributes = Map("data-sort-value" -> agentClient.clientName)
                        ),
                        TableRow(
                            content = Text(agentClient.employerReference)
                        ),
                        TableRow(
                            content = Text(agentClient.clientReference)
                        ),
                        TableRow(
                            content = HtmlContent(removeLinkCell(agentClient))
                        )
                    )
                },
                attributes = Map(
                    "id" -> "agent-client-list",
                    "data-module" -> "moj-sortable-table"
                )
            )
        )

        @pageNavigator(paginationViewModel)
    }

    @govukDetails(
        Details(
            summary = Text(messages("agent.clientListSearch.details.1.summary")),
            content = HtmlContent(downloadYourClientList)
        )
    )

    @govukDetails(
        Details(
            summary = Text(messages("agent.clientListSearch.details.2.summary")),
            content = HtmlContent(filingOnlyService)
        )
    )

}
